<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Attendance Dashboard</title>

  <!-- Supabase JS -->
  <script defer src="https://unpkg.com/@supabase/supabase-js@1.35.6/dist/umd/supabase.js"></script>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
  :root {
    --primary: #2563eb;
    --success: #22c55e;
    --warning: #f59e0b;
    --danger: #ef4444;
    --bg: #f8fafc;
    --text: #1e293b;
  }

  body {
    font-family: 'Inter', -apple-system, sans-serif;
    background-color: var(--bg);
    color: var(--text);
    padding: 40px 20px;
    max-width: 1000px;
    margin: 0 auto;
  }

  h1 { font-weight: 800; letter-spacing: -0.025em; margin-bottom: 30px; color: #0f172a; }

  /* Controls Card */
  .controls {
    background: white;
    padding: 24px;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    display: flex;
    gap: 24px;
    align-items: flex-end;
    margin-bottom: 25px;
  }

  .control-group { display: flex; flex-direction: column; gap: 8px; }
  .control-group label { font-size: 0.85rem; font-weight: 600; color: #64748b; }

  select, input[type="date"] {
    padding: 10px 14px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    outline: none;
    font-size: 0.95rem;
    background: #fff;
  }

  /* Statistics Grid */
  #summary {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 25px;
  }

  .stat-card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    border-bottom: 4px solid #e2e8f0;
  }

  .stat-card h3 { margin: 0; font-size: 0.75rem; text-transform: uppercase; color: #64748b; letter-spacing: 0.05em; }
  .stat-card p { margin: 8px 0 0; font-size: 1.75rem; font-weight: 700; }
  
  .card-total { border-color: var(--primary); }
  .card-present { border-color: var(--success); }
  .card-late { border-color: var(--warning); }
  .card-absent { border-color: var(--danger); }

  /* Table */
  #attendance-table {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  table { width: 100%; border-collapse: collapse; }
  th { background: #f1f5f9; color: #475569; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; padding: 12px 20px; text-align: left; }
  td { padding: 16px 20px; border-bottom: 1px solid #f1f5f9; font-size: 0.95rem; }
  tr:last-child td { border: none; }
  tr:hover { background-color: #f8fafc; }

  /* Highlighting new scans */
  .highlight { animation: highlightAnimation 2s ease-out; }
  @keyframes highlightAnimation {
    0%   { background-color: #fef9c3; }
    100% { background-color: transparent; }
  }

  /* Buttons */
  .btn-group { margin-top: 25px; display: flex; gap: 12px; }
  button {
    padding: 12px 24px;
    border-radius: 8px;
    border: none;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.9rem;
  }
  #export-pdf { background: #1e293b; color: white; }
  #export-csv { background: white; color: #1e293b; border: 1px solid #e2e8f0; }
  button:hover { opacity: 0.9; transform: translateY(-1px); }
</style>

  <script defer>
document.addEventListener('DOMContentLoaded', async () => {
  const supabaseUrl = 'https://cawrvnutflgvbrisuqtd.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNhd3J2bnV0ZmxndmJyaXN1cXRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwNDcwODgsImV4cCI6MjA4MTYyMzA4OH0.ZLSVVcZUl2muc584TL_UIYxykjrf_F_dOtDJp53A3cU';
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

  let attendanceSubscription = null;
  let previousPresentIds = [];
  const scanSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');

  async function loadClasses() {
    const { data, error } = await supabaseClient
      .from('students')
      .select('class_name_full')
      .order('class_name_full');

    if (error) return;
    const select = document.getElementById('class-select');
    const uniqueClasses = [...new Set(data.map(c => c.class_name_full))];
    select.innerHTML = uniqueClasses.map(c => `<option value="${c}">${c}</option>`).join('');
  }

  async function loadAttendance() {
    const selectedClass = document.getElementById('class-select').value;
    const selectedDate = document.getElementById('attendance-date').value || new Date().toISOString().split('T')[0];
    document.getElementById('today-date').innerText = 'Date: ' + selectedDate;

    // 1. Fetch data from Supabase
    const { data: students } = await supabaseClient
      .from('students')
      .select('*')
      .eq('class_name_full', selectedClass)
      .order('name');

    const { data: attendance } = await supabaseClient
      .from('students_attendance')
      .select('*')
      .eq('class_name', selectedClass)
      .eq('date', selectedDate);

    // 2. Merge and determine status
    const merged = students.map(s => {
      const att = attendance.find(a => a.student_id === s.id);
      let status = 'Absent', timestamp = 'â€”';
      
      if (att) {
        timestamp = att.timestamp.includes('T') ? att.timestamp.split('T')[1] : att.timestamp.split(' ')[1];
        const [hours, minutes] = timestamp.split(':').map(Number);
        
        // Late if after 08:00:00
        status = (hours > 8 || (hours === 8 && minutes > 0)) ? 'Late' : '/';
      }
      return { ...s, status, timestamp };
    });

    // 3. Update UI
    renderSummary(merged);
    renderTable(merged);
    renderAbsentList(merged);

    // 4. Update "Last Updated" timestamp
    const now = new Date();
    const lastUpdatedElem = document.getElementById('last-updated');
    if (lastUpdatedElem) {
      lastUpdatedElem.innerText = `Last Sync: ${now.toLocaleTimeString()}`;
    }

    // 5. Play sound for new arrivals (anyone not Absent who wasn't there before)
    const currentPresentIds = merged.filter(s => s.status !== 'Absent').map(s => s.id);
    const newArrivals = currentPresentIds.filter(id => !previousPresentIds.includes(id));
    
    if (newArrivals.length > 0 && previousPresentIds.length > 0) {
      scanSound.play().catch(() => {
        console.log("Audio playback blocked by browser until user interacts with page.");
      });
    }
    
    // Save current state for the next comparison
    previousPresentIds = currentPresentIds;
  }

  // UPDATED SUMMARY FUNCTION FOR YOUR NEW LOGIC
  function renderSummary(merged) {
    const totalCount = merged.length;
    const lateCount = merged.filter(s => s.status === 'Late').length;
    const absentCount = merged.filter(s => s.status === 'Absent').length;
    
    // Logic: Present = (/) + (Late)
    const presentCount = merged.filter(s => s.status === '/' || s.status === 'Late').length;

    document.getElementById('total-count').innerText = totalCount;
    document.getElementById('present-count').innerText = presentCount;
    document.getElementById('late-count').innerText = lateCount;
    document.getElementById('absent-count').innerText = absentCount;
  }

  function renderSummary(merged) {
    const totalCount = merged.length;
    const lateCount = merged.filter(s => s.status === 'Late').length;
    
    // Logic: Present = standard present (/) + late arrivals
    const presentCount = merged.filter(s => s.status === '/' || s.status === 'Late').length;
    
    const absentCount = merged.filter(s => s.status === 'Absent').length;

    document.getElementById('total-count').innerText = totalCount;
    document.getElementById('present-count').innerText = presentCount; // Now 9 in your example
    document.getElementById('late-count').innerText = lateCount;       // Still 6
    document.getElementById('absent-count').innerText = absentCount;
  }

  function renderTable(merged) {
    const tableDiv = document.getElementById('attendance-table');
    tableDiv.innerHTML = ''; // Clear the "Updating..." or old table

    const table = document.createElement('table');
    table.innerHTML = `
      <thead>
        <tr><th>Name</th><th>Barcode</th><th>Status</th><th>Time</th></tr>
      </thead>
      <tbody>
        ${merged.map(s => {
            // Logic for professional status badges
            let badgeColor = "";
            let statusText = s.status === '/' ? 'PRESENT' : s.status.toUpperCase();
            
            if (s.status === '/') badgeColor = "background: #dcfce7; color: #166534;";
            else if (s.status === 'Late') badgeColor = "background: #fef9c3; color: #854d0e;";
            else badgeColor = "background: #fee2e2; color: #991b1b;";

            const isNew = (s.status === '/' || s.status === 'Late') && !previousPresentIds.includes(s.id);

            return `
              <tr class="${isNew ? 'highlight' : ''}">
                <td style="font-weight: 600; color: #1e293b;">${s.name}</td>
                <td style="color: #64748b; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem;">${s.barcode}</td>
                <td>
                  <span style="display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 800; ${badgeColor}">
                    ${statusText}
                  </span>
                </td>
                <td style="color: #64748b; font-size: 0.9rem;">${s.timestamp}</td>
              </tr>`;
        }).join('')}
      </tbody>`;
    tableDiv.appendChild(table);
  }

  function renderAbsentList(merged) {
    const container = document.getElementById('absent-list-container');
    const listDiv = document.getElementById('absent-list');
    
    // Filter for students who are marked 'Absent'
    const absentees = merged.filter(s => s.status === 'Absent');

    if (absentees.length > 0) {
      container.style.display = 'block'; // Show the box
      // Join names with a bullet point or comma
      listDiv.innerHTML = absentees.map(s => `â€¢ ${s.name}`).join('<br>');
    } else {
      // If everyone is here, hide the box or show a success message
      container.style.display = 'block';
      container.style.backgroundColor = '#f0fdf4';
      container.style.borderColor = '#bbf7d0';
      listDiv.innerHTML = '<span style="color: #166534;">ðŸŽ‰ All students are present!</span>';
    }
  } 

  async function subscribeToAttendance() {
    const selectedClass = document.getElementById('class-select').value;
    const statusDot = document.getElementById('status-dot');

    if (attendanceSubscription) {
      await supabaseClient.removeSubscription(attendanceSubscription);
      attendanceSubscription = null;
    }

    await new Promise(r => setTimeout(r, 150)); // Stabilize connection

    attendanceSubscription = supabaseClient
      .from('students_attendance')
      .on('INSERT', (payload) => {
        if (payload.new.class_name === selectedClass) {
          loadAttendance();
        }
      })
      .subscribe((status) => {
        if (statusDot) {
          statusDot.style.backgroundColor = (status === 'SUBSCRIBED') ? '#22c55e' : '#ef4444';
        }
      });
  }

  document.getElementById('class-select').addEventListener('change', () => {
    document.getElementById('attendance-table').innerHTML = '<p style="text-align:center;">Switching class...</p>';
    loadAttendance();
    subscribeToAttendance();
  });

  document.getElementById('attendance-date').addEventListener('change', loadAttendance);

  // Initial Start
  await loadClasses();
  await loadAttendance();
  subscribeToAttendance();

  // =========================
  // Export PDF
  // =========================
  document.getElementById('export-pdf').addEventListener('click', () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Get the table element
    const tableElement = document.querySelector('#attendance-table table');
    
    if (!tableElement) {
      alert("No data available to export!");
      return;
    }

    // Capture the Header and Rows
    const headers = Array.from(tableElement.querySelectorAll('thead th')).map(th => th.innerText);
    const rows = Array.from(tableElement.querySelectorAll('tbody tr')).map(tr => 
      Array.from(tr.querySelectorAll('td')).map(td => td.innerText)
    );

    // Create the PDF
    doc.text(`Attendance Report: ${document.getElementById('class-select').value}`, 14, 15);
    doc.text(document.getElementById('today-date').innerText, 14, 22);
    
    doc.autoTable({
      head: [headers],
      body: rows,
      startY: 25,
      theme: 'grid'
    });

    doc.save(`Attendance_${new Date().toLocaleDateString()}.pdf`);
  });

  // =========================
  // Export CSV
  // =========================
  document.getElementById('export-csv').addEventListener('click', () => {
    const tableElement = document.querySelector('#attendance-table table');
    if (!tableElement) return;

    let csvContent = "";
    
    // Get Headers
    const headers = Array.from(tableElement.querySelectorAll('thead th'))
                         .map(th => `"${th.innerText}"`).join(",");
    csvContent += headers + "\n";

    // Get Body Rows
    const rows = Array.from(tableElement.querySelectorAll('tbody tr')).map(tr => {
      return Array.from(tr.querySelectorAll('td'))
                  .map(td => `"${td.innerText}"`).join(",");
    });
    csvContent += rows.join("\n");

    // Download Logic
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.setAttribute("href", url);
    link.setAttribute("download", `Attendance_${document.getElementById('class-select').value}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  });

});
  </script>
</head>

<body>
  <h1>Attendance Dashboard (Students)</h1>

  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
    <div id="status-dot" style="width: 10px; height: 10px; background: #ccc; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 0 1px #999;"></div>
    <span style="font-size: 0.85rem; color: #64748b; font-weight: 500;">Live Connection</span>
    <span id="last-updated" style="font-size: 0.85rem; color: #94a3b8; margin-left: auto;"></span>
  </div>

  <div class="controls">
    <div class="control-group">
      <label>Class Name</label>
      <select id="class-select"></select>
    </div>
    
    <div class="control-group">
      <label>Attendance Date</label>
      <input type="date" id="attendance-date">
    </div>

    <div class="control-group" style="flex-direction: row; align-items: flex-end; gap: 8px;">
      <button id="export-pdf" style="padding: 10px 16px;">Print PDF Report</button>
      <button id="export-csv" style="padding: 10px 16px;">Export CSV</button>
    </div>

    <div style="margin-left: auto; text-align: right;">
      <p id="today-date" style="margin: 0; font-weight: 700; color: var(--primary); font-size: 1.1rem;"></p>
    </div>
  </div>

  <div id="summary">
    <div class="stat-card card-total">
      <h3>Total Students</h3>
      <p id="total-count">0</p>
    </div>
    <div class="stat-card card-present">
      <h3>Present</h3>
      <p id="present-count">0</p>
    </div>
    <div class="stat-card card-late">
      <h3>Late</h3>
      <p id="late-count">0</p>
    </div>
    <div class="stat-card card-absent">
      <h3>Absent</h3>
      <p id="absent-count">0</p>
    </div>
  </div>

  <div id="absent-list-container" style="display: none; background: #fff1f2; border-left: 4px solid var(--danger); padding: 20px; border-radius: 12px; margin-bottom: 25px;">
    <h3 style="color: #991b1b; margin: 0 0 10px 0; font-size: 1rem;">Students Not Yet Present:</h3>
    <div id="absent-list" style="color: #b91c1c; font-weight: 500; font-size: 0.95rem; line-height: 1.6;"></div>
  </div>

  <div id="attendance-table"></div>

</body>
</html>
