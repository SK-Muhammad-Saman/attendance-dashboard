<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Attendance Dashboard</title>

  <!-- Supabase JS -->
  <script defer src="https://unpkg.com/@supabase/supabase-js@1.35.6/dist/umd/supabase.js"></script>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <style>
    .highlight {
      animation: highlightAnimation 3s ease;
    }

    @keyframes highlightAnimation {
      0%   { background-color: yellow; }
      100% { background-color: transparent; }
    }

    table {
      border-collapse: collapse;
      width: 100%;
    }

    th, td {
      border: 1px solid #333;
      padding: 6px;
      text-align: left;
    }
  </style>

  <script defer>
document.addEventListener('DOMContentLoaded', async () => {
  const supabaseUrl = 'https://cawrvnutflgvbrisuqtd.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNhd3J2bnV0ZmxndmJyaXN1cXRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwNDcwODgsImV4cCI6MjA4MTYyMzA4OH0.ZLSVVcZUl2muc584TL_UIYxykjrf_F_dOtDJp53A3cU';
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

  const REFRESH_SECONDS = 10;
  let refreshInterval = null;

  // Store previous attendance for highlighting
  let previousPresentIds = [];

  // =========================
  // Load class dropdown
  // =========================
  async function loadClasses() {
    const { data, error } = await supabaseClient
      .from('students')
      .select('class_name_full')
      .order('class_name_full');

    if (error) { console.error('Class load error:', error); return; }

    const select = document.getElementById('class-select');
    select.innerHTML = '';
    const uniqueClasses = [...new Set(data.map(c => c.class_name_full))];

    uniqueClasses.forEach(c => {
      const option = document.createElement('option');
      option.value = c;
      option.textContent = c;
      select.appendChild(option);
    });
  }

  // =========================
  // Load attendance
  // =========================
  async function loadAttendance() {
    const selectedClass = document.getElementById('class-select').value;
    const selectedDate = document.getElementById('attendance-date').value || new Date().toISOString().split('T')[0];
    document.getElementById('today-date').innerText = 'Date: ' + selectedDate;

    const { data: students, error: studentError } = await supabaseClient
      .from('students')
      .select('*')
      .eq('class_name_full', selectedClass)
      .order('name');

    if (studentError) { console.error(studentError); return; }

    const { data: attendance, error: attError } = await supabaseClient
      .from('students_attendance')
      .select('*')
      .eq('class_name', selectedClass)
      .eq('date', selectedDate);

    if (attError) { console.error(attError); return; }

    // Merge students with attendance
    const merged = students.map(s => {
      const att = attendance.find(a => a.student_id === s.id);
      let status = 'Absent';
      let timestamp = 'â€”';
      if (att) {
        timestamp = att.timestamp.split('T')[1] || att.timestamp.split(' ')[1];
        status = timestamp > '08:00:00' ? 'Late' : '/';
      }
      return { ...s, status, timestamp };
    });

    // =========================
    // Summary
    // =========================
    const totalCount = merged.length;
    const lateCount = merged.filter(s => s.status === 'Late').length;
    const presentCount = merged.filter(s => s.status === '/' || s.status === 'Late').length;
    const absentCount = merged.filter(s => s.status === 'Absent').length;

    document.getElementById('total-count').innerText = totalCount;
    document.getElementById('present-count').innerText = presentCount;
    document.getElementById('late-count').innerText = lateCount;
    document.getElementById('absent-count').innerText = absentCount;

    // =========================
    // Render table with highlight
    // =========================
    const tableDiv = document.getElementById('attendance-table');
    tableDiv.innerHTML = '';

    const table = document.createElement('table');
    const thead = document.createElement('thead');
    thead.innerHTML = `
      <tr>
        <th>Name</th>
        <th>Barcode</th>
        <th>Status</th>
        <th>Time</th>
      </tr>`;
    table.appendChild(thead);

    const tbody = document.createElement('tbody');

    merged.forEach(s => {
      const tr = document.createElement('tr');
      let color = s.status === '/' ? 'green' : (s.status === 'Late' ? 'orange' : 'red');
      tr.innerHTML = `
        <td>${s.name}</td>
        <td>${s.barcode}</td>
        <td style="color:${color}">${s.status}</td>
        <td>${s.timestamp}</td>
      `;

      // Highlight newly arrived students
      if ((s.status === '/' || s.status === 'Late') && !previousPresentIds.includes(s.id)) {
        tr.classList.add('highlight');
      }

      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    tableDiv.appendChild(table);

    // Update previousPresentIds
    previousPresentIds = merged.filter(s => s.status === '/' || s.status === 'Late').map(s => s.id);
  }

  // =========================
  // Auto-refresh
  // =========================
  function startAutoRefresh() {
    if (refreshInterval) clearInterval(refreshInterval);
    refreshInterval = setInterval(loadAttendance, REFRESH_SECONDS * 1000);
  }

  // =========================
  // Event listeners
  // =========================
  document.getElementById('class-select').addEventListener('change', () => {
    loadAttendance();
    startAutoRefresh();
  });

  document.getElementById('attendance-date').addEventListener('change', loadAttendance);

  // =========================
  // Initial load
  // =========================
  await loadClasses();
  loadAttendance();
  startAutoRefresh();

  // =========================
  // Export PDF
  // =========================
  document.getElementById('export-pdf').addEventListener('click', () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const rows = [];
    document.querySelectorAll('#attendance-table tr').forEach(tr => {
      const row = Array.from(tr.querySelectorAll('td, th')).map(td => td.innerText);
      rows.push(row);
    });

    doc.autoTable({ head: [rows[0]], body: rows.slice(1) });
    doc.save('attendance.pdf');
  });

  // =========================
  // Export CSV
  // =========================
  document.getElementById('export-csv').addEventListener('click', () => {
    const table = document.getElementById('attendance-table');
    if (!table) return;

    let csv = [];
    const rows = table.querySelectorAll('tr');
    rows.forEach(row => {
      const cols = row.querySelectorAll('td, th');
      const rowData = Array.from(cols).map(col => `"${col.innerText}"`);
      csv.push(rowData.join(','));
    });

    const csvString = csv.join('\n');
    const blob = new Blob([csvString], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = 'attendance.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  });

});
  </script>
</head>

<body>
  <h1>Attendance Dashboard</h1>

  <div style="margin-bottom:15px;">
    <label><strong>Class:</strong></label>
    <select id="class-select"></select>
  </div>

  <div style="margin-bottom:15px;">
    <label for="attendance-date"><strong>Date:</strong></label>
    <input type="date" id="attendance-date">
  </div>

  <p id="today-date"></p>

  <div id="summary" style="margin-bottom:15px;">
    Total: <span id="total-count">0</span> | 
    Present: <span id="present-count">0</span> | 
    Late: <span id="late-count">0</span> | 
    Absent: <span id="absent-count">0</span>
  </div>

  <div style="margin-bottom:15px;">
    <button id="export-pdf">Print PDF</button>
    <button id="export-csv">Export CSV</button>
  </div>

  <div id="attendance-table"></div>
</body>
</html>
