<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Attendance Dashboard</title>

  <!-- Supabase JS -->
  <script defer src="https://unpkg.com/@supabase/supabase-js@1.35.6/dist/umd/supabase.js"></script>
  <!-- jsPDF and jsPDF-AutoTable for proper table PDF -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <script defer>
document.addEventListener('DOMContentLoaded', async () => {
    const supabaseUrl = 'https://cawrvnutflgvbrisuqtd.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNhd3J2bnV0ZmxndmJyaXN1cXRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwNDcwODgsImV4cCI6MjA4MTYyMzA4OH0.ZLSVVcZUl2muc584TL_UIYxykjrf_F_dOtDJp53A3cU';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    let refreshInterval = null;
    const REFRESH_SECONDS = 5;

    // Load class dropdown dynamically
    async function loadClasses() {
      const { data, error } = await supabaseClient
        .from('students')
        .select('class_name_full')
        .order('class_name_full');
      if (error) return console.error(error);

      const select = document.getElementById('class-select');
      select.innerHTML = '';
      const uniqueClasses = [...new Set(data.map(c => c.class_name_full))];
      uniqueClasses.forEach(c => {
        const option = document.createElement('option');
        option.value = c;
        option.textContent = c;
        select.appendChild(option);
      });
    }

    function startAutoRefresh() {
      if (refreshInterval) clearInterval(refreshInterval);
      refreshInterval = setInterval(() => loadAttendance(), REFRESH_SECONDS * 1000);
    }

    async function loadAttendance() {
      const selectedClass = document.getElementById('class-select').value;
      const selectedDate = document.getElementById('attendance-date').value;

      const todayElem = document.getElementById('today-date');
      const presentElem = document.getElementById('present-count');
      const absentElem = document.getElementById('absent-count');
      const tableElem = document.getElementById('attendance-table');
      if (!todayElem || !presentElem || !absentElem || !tableElem) return;

      todayElem.innerText = 'Date: ' + selectedDate;

      const { data: students, error: studentError } = await supabaseClient
        .from('students')
        .select('*')
        .eq('class_name_full', selectedClass)
        .order('name');
      if (studentError) return console.error(studentError);

      const { data: attendance, error: attError } = await supabaseClient
        .from('students_attendance')
        .select('*')
        .eq('class_name', selectedClass)
        .eq('date', selectedDate);
      if (attError) return console.error(attError);

      const merged = students.map(s => {
        const att = attendance.find(a => a.student_id === s.id);
        let timeStr = 'â€”';
        if (att?.timestamp) timeStr = att.timestamp.split('T')[1].split('.')[0];
        return { ...s, status: att ? att.status : 'Absent', timestamp: timeStr };
      });

      // Update summary
      presentElem.innerText = merged.filter(s => s.status === '/').length;
      absentElem.innerText = merged.filter(s => s.status === 'Absent').length;

      // Build table
      let html = `
        <table border="1" cellpadding="6">
          <tr>
            <th>Name</th>
            <th>Standard</th>
            <th>Barcode</th>
            <th>Status</th>
            <th>Time</th>
          </tr>`;
      merged.forEach(s => {
        const color = s.status === '/' ? 'green' : s.status === 'Absent' ? 'red' : 'black';
        html += `
          <tr>
            <td>${s.name}</td>
            <td>${s.standard}</td>
            <td>${s.barcode}</td>
            <td style="color:${color}">${s.status}</td>
            <td>${s.timestamp}</td>
          </tr>`;
      });
      html += '</table>';
      tableElem.innerHTML = html;
    }

    // ===============================
    // Export CSV
    // ===============================
    function exportCSV() {
      const table = document.querySelector('#attendance-table table');
      if (!table) return alert('No data to export');

      let csv = [];
      table.querySelectorAll('tr').forEach(row => {
        const cols = row.querySelectorAll('th, td');
        csv.push(Array.from(cols).map(c => `"${c.innerText}"`).join(','));
      });
      const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'attendance.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    // ===============================
    // Export PDF using AutoTable
    // ===============================
    function exportPDF() {
      const table = document.querySelector('#attendance-table table');
      if (!table) return alert('No data to export');

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const headers = [];
      table.querySelectorAll('tr:first-child th').forEach(th => headers.push(th.innerText));

      const body = [];
      table.querySelectorAll('tr:not(:first-child)').forEach(tr => {
        const row = [];
        tr.querySelectorAll('td').forEach(td => row.push(td.innerText));
        body.push(row);
      });

      doc.autoTable({
        head: [headers],
        body: body,
        startY: 20,
        theme: 'grid',
        headStyles: { fillColor: [41, 128, 185], textColor: 255 },
        styles: { fontSize: 10 }
      });

      doc.text('Attendance - ' + document.getElementById('class-select').value, 14, 15);
      doc.save('attendance.pdf');
    }

    // ===============================
    // Event listeners
    // ===============================
    document.getElementById('class-select').addEventListener('change', () => {
      loadAttendance();
      startAutoRefresh();
    });
    document.getElementById('attendance-date').addEventListener('change', loadAttendance);
    document.getElementById('export-csv').addEventListener('click', exportCSV);
    document.getElementById('export-pdf').addEventListener('click', exportPDF);

    // ===============================
    // Initial load
    // ===============================
    await loadClasses();
    const dateInput = document.getElementById('attendance-date');
    dateInput.value = new Date().toISOString().split('T')[0]; // today
    loadAttendance();
    startAutoRefresh();
});
  </script>
</head>

<body>
  <h1>Attendance Dashboard</h1>

  <div style="margin-bottom:15px;">
    <label><strong>Class:</strong></label>
    <select id="class-select"></select>
  </div>

  <div style="margin-bottom:15px;">
    <label for="attendance-date"><strong>Date:</strong></label>
    <input type="date" id="attendance-date">
  </div>

  <p id="today-date"></p>

  <div id="summary" style="margin-bottom:15px;">
    <strong>Present:</strong> <span id="present-count">0</span>
    <strong>Absent:</strong> <span id="absent-count">0</span>
  </div>

  <div style="margin-bottom:15px;">
    <button id="export-pdf">Print PDF</button>
    <button id="export-csv">Export CSV</button>
  </div>

  <div id="attendance-table"></div>
</body>
</html>
